<x-app-layout>
    <div class="p-6 max-w-5xl mx-auto">
        <h2 class="text-2xl font-semibold text-blue-700 mb-6">┖ Registrar nuevo paciente</h2>

        <form method="POST" action="{{ route('medico.paciente.store') }}" id="formPaciente" class="space-y-6">
            @csrf

            {{-- Datos personales --}}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium">C茅dula</label>
                    <input type="text" name="cedula" id="cedula" maxlength="10" required
                        class="border rounded w-full px-3 py-2"
                        placeholder="Ej: 1312345678">
                    <small id="cedulaError" class="text-red-500 hidden">C茅dula no v谩lida</small>
                </div>

                <div>
                    <label class="block text-sm font-medium">Primer Nombre</label>
                    <input type="text" name="primer_nombre" class="border rounded w-full px-3 py-2" required>
                </div>

                <div>
                    <label class="block text-sm font-medium">Segundo Nombre</label>
                    <input type="text" name="segundo_nombre" class="border rounded w-full px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-medium">Apellido Paterno</label>
                    <input type="text" name="apellido_paterno" class="border rounded w-full px-3 py-2" required>
                </div>

                <div>
                    <label class="block text-sm font-medium">Apellido Materno</label>
                    <input type="text" name="apellido_materno" class="border rounded w-full px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-medium">Fecha de Nacimiento</label>
                    <input type="date" name="fecha_nacimiento" id="fecha_nacimiento" class="border rounded w-full px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-medium">Edad</label>
                    <input type="number" name="edad" id="edad" readonly class="border rounded w-full px-3 py-2 bg-gray-100">
                </div>

                <div>
                    <label class="block text-sm font-medium">Sexo</label>
                    <select name="sexo" class="border rounded w-full px-3 py-2">
                        <option value="">Seleccione</option>
                        <option>Masculino</option>
                        <option>Femenino</option>
                    </select>
                </div>
            </div>

            {{-- Datos de residencia --}}
            <hr class="my-4">
            <h3 class="text-lg font-semibold text-gray-700"> Direcci贸n</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium">Provincia</label>
                    <select id="provincia" name="provincia" class="border rounded w-full px-3 py-2" required>
                        <option value="">Seleccione provincia</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Cant贸n</label>
                    <select id="canton" name="canton" class="border rounded w-full px-3 py-2" required>
                        <option value="">Seleccione cant贸n</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Parroquia</label>
                    <select id="parroquia" name="parroquia" class="border rounded w-full px-3 py-2" required>
                        <option value="">Seleccione parroquia</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium">Direcci贸n exacta</label>
                <input type="text" name="direccion" class="border rounded w-full px-3 py-2">
            </div>

            {{-- Contacto --}}
            <hr class="my-4">
            <h3 class="text-lg font-semibold text-gray-700"> Contacto</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium">Tel茅fono personal</label>
                    <input type="text" name="telefono" maxlength="10" class="border rounded w-full px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Contacto de emergencia</label>
                    <input type="text" name="contacto_emergencia" class="border rounded w-full px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Parentesco</label>
                    <input type="text" name="parentesco_contacto" class="border rounded w-full px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Tel茅fono contacto</label>
                    <input type="text" name="telefono_contacto" maxlength="10" class="border rounded w-full px-3 py-2">
                </div>
            </div>

            {{-- Botones --}}
            <div class="flex justify-end space-x-3">
                <a href="{{ route('medico.pacientes') }}" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancelar</a>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Guardar</button>
            </div>
        </form>
    </div>

    {{-- Script para provincias/cantones/parroquias y validaciones --}}
    <script>
        const provinciasUrl = '/provincias.json'; // coloca el archivo en public/

        async function cargarProvincias() {
            const response = await fetch(provinciasUrl);
            const data = await response.json();
            const provinciaSelect = document.getElementById('provincia');

            Object.keys(data).forEach(id => {
                const opt = document.createElement('option');
                opt.value = data[id].provincia;
                opt.text = data[id].provincia;
                opt.dataset.cantones = JSON.stringify(data[id].cantones);
                provinciaSelect.add(opt);
            });

            provinciaSelect.addEventListener('change', function() {
                const cantonSelect = document.getElementById('canton');
                const parroquiaSelect = document.getElementById('parroquia');
                cantonSelect.innerHTML = '<option value="">Seleccione cant贸n</option>';
                parroquiaSelect.innerHTML = '<option value="">Seleccione parroquia</option>';

                const cantones = JSON.parse(this.options[this.selectedIndex].dataset.cantones || '{}');
                Object.keys(cantones).forEach(cid => {
                    const opt = document.createElement('option');
                    opt.value = cantones[cid].canton;
                    opt.text = cantones[cid].canton;
                    opt.dataset.parroquias = JSON.stringify(cantones[cid].parroquias);
                    cantonSelect.add(opt);
                });
            });

            document.getElementById('canton').addEventListener('change', function() {
                const parroquiaSelect = document.getElementById('parroquia');
                parroquiaSelect.innerHTML = '<option value="">Seleccione parroquia</option>';
                const parroquias = JSON.parse(this.options[this.selectedIndex].dataset.parroquias || '{}');
                Object.keys(parroquias).forEach(pid => {
                    const opt = document.createElement('option');
                    opt.value = parroquias[pid];
                    opt.text = parroquias[pid];
                    parroquiaSelect.add(opt);
                });
            });
        }

        cargarProvincias();

        // Validaci贸n de c茅dula
        document.getElementById('cedula').addEventListener('input', function() {
            const cedula = this.value;
            const error = document.getElementById('cedulaError');
            if (cedula.length === 10 && !validarCedula(cedula)) {
                error.classList.remove('hidden');
            } else {
                error.classList.add('hidden');
            }
        });

        function validarCedula(cedula) {
            if (!/^\d{10}$/.test(cedula)) return false;
            const prov = parseInt(cedula.substr(0, 2));
            if (prov < 1 || prov > 24) return false;
            const d3 = parseInt(cedula[2]);
            if (d3 > 6) return false;
            const coef = [2,1,2,1,2,1,2,1,2];
            let suma = 0;
            for (let i=0;i<9;i++){
                let mult = parseInt(cedula[i]) * coef[i];
                if (mult >= 10) mult -= 9;
                suma += mult;
            }
            let verificador = 10 - (suma % 10);
            if (verificador === 10) verificador = 0;
            return verificador === parseInt(cedula[9]);
        }

        // Calcular edad
        document.getElementById('fecha_nacimiento').addEventListener('change', function() {
            const fecha = new Date(this.value);
            const hoy = new Date();
            let edad = hoy.getFullYear() - fecha.getFullYear();
            const mes = hoy.getMonth() - fecha.getMonth();
            if (mes < 0 || (mes === 0 && hoy.getDate() < fecha.getDate())) edad--;
            document.getElementById('edad').value = edad > 0 ? edad : 0;
        });
    </script>
</x-app-layout>
